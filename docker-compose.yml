# -----------------------------------------------------------------------------
# Network
# -----------------------------------------------------------------------------
networks:
  eds-network:
    driver: bridge

# -----------------------------------------------------------------------------
# Named Volume
# -----------------------------------------------------------------------------
volumes:
  db_data:
    name: eds_db_data
  node_modules:
    name: eds_node_modules

# -----------------------------------------------------------------------------
# Shared Configuration Anchors
# -----------------------------------------------------------------------------
x-service-defaults: &service_defaults
  platform: linux/arm64
  restart: unless-stopped
  mem_limit: 1g
  networks:
    - eds-network

x-light-service: &light_service
  <<: *service_defaults
  mem_limit: 256m

# -----------------------------------------------------------------------------
# Healthcheck Anchor
# -----------------------------------------------------------------------------
x-health-defaults: &health_defaults
  interval: 30s
  timeout: 3s
  retries: 5
  start_period: 60s

# -----------------------------------------------------------------------------
# TMPFS Anchor (common dev tmp)
# -----------------------------------------------------------------------------
x-tmpfs: &tmpfs
  - /tmp

# -----------------------------------------------------------------------------
# WordPress Environment Anchor
# -----------------------------------------------------------------------------
x-wordpress-env: &wordpress_env
  WORDPRESS_DB_HOST: db:3306
  WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
  WORDPRESS_DB_USER: ${MYSQL_USER}
  WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
  WORDPRESS_TABLE_PREFIX: ${WORDPRESS_TABLE_PREFIX:-wp_}
  AUTH_KEY: ${AUTH_KEY}
  SECURE_AUTH_KEY: ${SECURE_AUTH_KEY}
  LOGGED_IN_KEY: ${LOGGED_IN_KEY}
  NONCE_KEY: ${NONCE_KEY}
  AUTH_SALT: ${AUTH_SALT}
  SECURE_AUTH_SALT: ${SECURE_AUTH_SALT}
  LOGGED_IN_SALT: ${LOGGED_IN_SALT}
  NONCE_SALT: ${NONCE_SALT}
  WORDPRESS_CONFIG_EXTRA: |
    define('WP_MEMORY_LIMIT', '256M');
    define('WP_DEBUG', true);
    define('WP_DEBUG_LOG', true);
    define('WP_DEBUG_DISPLAY', true);
    define('SCRIPT_DEBUG', true);
    define('DISABLE_WP_CRON', true);
    define('WP_CACHE', false);

    @ini_set('upload_max_filesize', '64M');  
    @ini_set('post_max_size', '64M');
    @ini_set('max_execution_time', '300');
    @ini_set('display_errors', 1);
    @ini_set('error_reporting', E_ALL);

    ini_set('opcache.enable', 0);
    ini_set('opcache.memory_consumption', 128);
    ini_set('opcache.interned_strings_buffer', 8);
    ini_set('opcache.max_accelerated_files', 10000);
    ini_set('opcache.revalidate_freq', 0);
    ini_set('opcache.validate_timestamps', 1);

# -----------------------------------------------------------------------------
# Volumes Anchors
# -----------------------------------------------------------------------------
x-wp-volumes: &wp_volumes
  - ./wp-content:/var/www/html/wp-content
  - ./logs:/var/www/html/wp-content/logs

x-node-volumes: &node_volumes
  - ./wp-content/themes/event-designs-by-sherry-theme:/app
  - node_modules:/app/node_modules

# -----------------------------------------------------------------------------
# Service Templates
# -----------------------------------------------------------------------------
x-wp-service: &wp_service
  <<: *service_defaults
  volumes: *wp_volumes
  tmpfs: *tmpfs
  environment:
    <<: *wordpress_env

x-node-service: &node_service
  <<: *service_defaults
  volumes: *node_volumes
  environment:
    NODE_ENV: development
    CHOKIDAR_USEPOLLING: "false"
    CHOKIDAR_INTERVAL: 300
    HOST: 0.0.0.0

# -----------------------------------------------------------------------------
# Services
# -----------------------------------------------------------------------------
services:
  db:
    <<: *service_defaults
    container_name: eds-db
    image: mysql:8.0
    command:
      - --default-authentication-plugin=mysql_native_password
      - --innodb-buffer-pool-size=256M
      - --max-connections=20
      - --skip-log-bin
      - --skip-name-resolve
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-redo-log-capacity=67108864
    environment:
      TZ: UTC
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql:delegated
    healthcheck:
      <<: *health_defaults
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$${MYSQL_ROOT_PASSWORD} --silent"]

  wordpress:
    <<: *wp_service
    container_name: eds-wordpress
    image: wordpress:php8.3-apache
    ports:
      - "${WP_PORT:-8081}:80"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      <<: *health_defaults
      test: ["CMD-SHELL", "curl -fso /dev/null http://localhost/wp-login.php || exit 1"]

  wpcli:
    <<: *light_service
    container_name: eds-wpcli
    image: wordpress:cli
    working_dir: /var/www/html
    user: "33:33"
    entrypoint: ["tail", "-f", "/dev/null"]
    volumes: *wp_volumes
    environment:
      <<: *wordpress_env
    depends_on:
      wordpress:
        condition: service_healthy
    restart: "no"

  node:
    <<: *node_service
    container_name: eds-node
    image: node:20-bullseye
    working_dir: /app
    ports:
      - "${NODE_PORT:-3000}:3000"
    command: >
      sh -c "
        LOCK_HASH=$$(md5sum package-lock.json | cut -d' ' -f1);
        STAMP=/app/node_modules/.install-stamp;
        if [ ! -f $$STAMP ] || [ \"$$(cat $$STAMP)\" != \"$$LOCK_HASH\" ]; then
          echo 'Dependencies changed or missing â€” running npm ci...';
          npm ci && echo $$LOCK_HASH > $$STAMP;
        fi &&
        exec npm run dev -- --host 0.0.0.0
      "
    depends_on:
      wordpress:
        condition: service_started

  phpmyadmin:
    <<: *light_service
    container_name: eds-phpmyadmin
    image: phpmyadmin:latest
    ports:
      - "${PMA_PORT:-8082}:80"
    environment:
      PMA_HOST: db
    depends_on:
      db:
        condition: service_healthy

  mailpit:
    <<: *light_service
    container_name: eds-mailpit
    image: axllent/mailpit:latest
    ports:
      - "${MAIL_UI_PORT:-8025}:8025"
      - "${MAIL_SMTP_PORT:-1025}:1025"
