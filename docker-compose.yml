# -----------------------------------------------------------------------------
# Shared Configuration
# -----------------------------------------------------------------------------

x-service-defaults: &service_defaults
  restart: unless-stopped
  mem_limit: 1g

# -----------------------------------------------------------------------------
# Services
# -----------------------------------------------------------------------------

services:

  # ---------------------------------------------------------------------------
  # MySQL Database
  # ---------------------------------------------------------------------------
  db:
    <<: *service_defaults

    image: mysql:8.0

    command:
      - --default-authentication-plugin=mysql_native_password
      - --innodb-buffer-pool-size=512M
      - --max-connections=50
      - --skip-log-bin
      - --skip-name-resolve
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci

    environment:
      TZ: UTC
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}

    volumes:
      - db_data:/var/lib/mysql

    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 10s
      timeout: 5s
      retries: 5


  # ---------------------------------------------------------------------------
  # WordPress (Apache + PHP 8.3)
  # ---------------------------------------------------------------------------
  wordpress:
    <<: *service_defaults

    image: wordpress:php8.3-apache
    container_name: eds-wordpress

    ports:
      - "8081:80"

    depends_on:
      db:
        condition: service_healthy

    tmpfs:
      - /tmp

    environment:
      # Database
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
      WORDPRESS_DB_USER: ${MYSQL_USER}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
      WORDPRESS_TABLE_PREFIX: ${WORDPRESS_TABLE_PREFIX}

      # Security Keys
      AUTH_KEY: ${AUTH_KEY}
      SECURE_AUTH_KEY: ${SECURE_AUTH_KEY}
      LOGGED_IN_KEY: ${LOGGED_IN_KEY}
      NONCE_KEY: ${NONCE_KEY}
      AUTH_SALT: ${AUTH_SALT}
      SECURE_AUTH_SALT: ${SECURE_AUTH_SALT}
      LOGGED_IN_SALT: ${LOGGED_IN_SALT}
      NONCE_SALT: ${NONCE_SALT}

      # Extra Config
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_MEMORY_LIMIT', '512M');
        define('DISABLE_WP_CRON', true);
        define('WP_DEBUG', false);
        define('WP_CACHE', true);

        @ini_set('upload_max_filesize', '64M');
        @ini_set('post_max_size', '64M');
        @ini_set('max_execution_time', '300');

        ini_set('opcache.enable', 1);
        ini_set('opcache.memory_consumption', 256);
        ini_set('opcache.interned_strings_buffer', 16);
        ini_set('opcache.max_accelerated_files', 20000);
        ini_set('opcache.revalidate_freq', 2);
        ini_set('opcache.validate_timestamps', 1);

    volumes:
      # WordPress core in Docker (FAST)
      - wordpress_core:/var/www/html
      # Only editable directories mounted
      - ./wp-content/themes:/var/www/html/wp-content/themes:delegated
      - ./wp-content/plugins:/var/www/html/wp-content/plugins:delegated
      - ./wp-content/uploads:/var/www/html/wp-content/uploads:delegated
    networks:
      - eds-network

# -----------------------------------------------------------------------------
# Named Volumes (Explicit Naming = No Future Surprises)
# -----------------------------------------------------------------------------

volumes:
  db_data:
    name: eds_db_data

# wordpress_data removed to prevent overwriting core
